#!/usr/bin/env bash

. ~/.nvm/nvm.sh

nvm use v6
yarn

cp ./../shared/knexfile.js ./
cp ./../shared/config.js ./config/
ln -sf /home/deploy/apps/tdc/shared/uploads /home/deploy/apps/tdc/current/public/

# copy badges for default campaigns
if [ ! -d /home/deploy/apps/tdc/current/public/uploads/staging/badges/ ];
  mkdir /home/deploy/apps/tdc/current/public/uploads/staging/badges/
fi

cp -r ./public/images/badges/* /home/deploy/apps/tdc/current/public/uploads/staging/badges/

yarn build

NODE_ENV=staging yarn db:migrate

pm2 startOrRestart ecosystem.json --env staging
